# Compiler
FC = mpif90

# Paths (Modify if necessary)
ROOT_DIR := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))
PARENT_DIR := $(abspath $(ROOT_DIR)/..)
CUDECOMP_DIR = $(PARENT_DIR)/cuDecomp-main/build/
CUDA_DIR = /leonardo/prod/opt/compilers/cuda/12.3/none/
EXTRA_DIR = /leonardo/prod/opt/compilers/cuda/12.3/none/compat

# Compiler and Linker Flags
FFLAGS = -gpu=managed -cpp -Mfree -cuda -I$(CUDECOMP_DIR)/include
LDFLAGS = -L$(CUDECOMP_DIR)/lib -L$(CUDA_DIR)/lib64 -Wl,-rpath,$(EXTRA_DIR)
LIBS = -lcudecomp_fort -lcudecomp -cudalib=cufft -cuda

# Source and Object Files
SRCS = main.f90
OBJS = $(SRCS:.f90=.o)

# Output Executable
TARGET = mhit36

# Default Rule
all: $(TARGET)

# Linking
$(TARGET): $(OBJS)
	$(FC) $(LDFLAGS) -o $(TARGET) $(OBJS) $(LIBS)

# Compilation Rule
%.o: %.f90
	$(FC) $(FFLAGS) -c $< -o $@

# Clean Rule
clean:
	rm -f $(TARGET) $(OBJS) *.mod
